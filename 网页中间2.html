<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â€œå¤©ç©ºå“¨å…µâ€â€”â€”AIé©±åŠ¨çš„æ°´åŸŸç¯å¢ƒæ™ºèƒ½æ„ŸçŸ¥å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add Leaflet CSS and JS for map integration -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d8N2y/rliCHo/zzf4F8GvM2sL87eJ/NYxU8s7n+r9N/Q==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d8N2y/rliCHo/zzf4F8GvM2sL87eJ/NYxU8s7n+r9N/Q==" crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-image: url('static/bg.png'); /* Local background image */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #333;
        }

        /* New glass effect style */
        .glass-effect {
            background: rgba(255, 255, 255, 0.85); /* 85% opacity, less transparent for readability */
            -webkit-backdrop-filter: blur(8px); /* Frosted glass effect for Safari */
            backdrop-filter: blur(8px); /* Standard frosted glass effect */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border to define edges */
        }

        .chart-container {
            position: relative;
            width: 100%;
            /* Make chart containers flexible within their grid cells */
            height: 300px; /* Consistent height for charts */
            max-height: 40vh; /* Responsive max height */
        }

        /* Adjusted navigation item active state color to match the image's teal/blue theme */
        .nav-item.active {
            background-color: #427C9F; /* A lighter, more active blue-teal */
            color: white;
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .message-box.show {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background-color: #e0f7fa;
            color: #00796b;
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.ai {
            background-color: #f3e5f5;
            color: #6a1b9a;
            align-self: flex-start;
            margin-right: auto;
        }

        .chat-message.system {
            background-color: #ffe0b2;
            color: #e65100;
            align-self: center;
            text-align: center;
            font-style: italic;
        }
        /* Specific style for the map container */
        #map {
            height: 450px; /* Adjusted height for a larger map area */
            width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem; /* Add some space below the map */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md transform transition-all">
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button id="login-tab" class="py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600 flex-1 text-center">ç™»å½•</button>
                    <button id="register-tab" class="py-2 px-4 font-semibold text-gray-500 flex-1 text-center">æ³¨å†Œ</button>
                </div>
            </div>

            <div id="login-form">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">æ¬¢è¿å›æ¥</h2>
                <form onsubmit="event.preventDefault(); handleLogin();">
                    <div class="mb-4">
                        <label for="login-phone" class="block text-gray-700 text-sm font-bold mb-2">æ‰‹æœºå·</label>
                        <input id="login-phone" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="18814893256" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">ç®¡ç†å‘˜æµ‹è¯•è´¦å·: 18814893256</p>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">å¯†ç </label>
                        <input id="login-password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " value="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                         <p class="text-xs text-gray-500 mt-1">é€šç”¨æµ‹è¯•å¯†ç : password</p>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm mb-4 h-5"></div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                        ç™»å½•
                    </button>
                </form>
            </div>

            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">åˆ›å»ºæ–°è´¦æˆ·</h2>
                <form onsubmit="event.preventDefault(); handleRegister();">
                    <div class="mb-4">
                        <label for="register-phone" class="block text-gray-700 text-sm font-bold mb-2">æ‰‹æœºå·</label>
                        <input id="register-phone" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">å¯†ç </label>
                        <input id="register-password" type="password" placeholder="è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="register-otp" class="block text-gray-700 text-sm font-bold mb-2">çŸ­ä¿¡éªŒè¯ç </label>
                        <div class="flex">
                            <input id="register-otp" type="text" placeholder="6ä½éªŒè¯ç " class="shadow appearance-none border rounded-l w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="send-otp-btn" onclick="handleSendOtp()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r transition duration-300 whitespace-nowrap">
                                å‘é€éªŒè¯ç 
                            </button>
                        </div>
                    </div>
                    <div id="register-error" class="text-red-500 text-sm mb-4 h-5"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                        æ³¨å†Œ
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex h-screen">
        <aside class="w-64 bg-[#2A3F54] text-gray-200 flex flex-col transition-all duration-300">
            <div class="p-4 flex items-center space-x-3 border-b border-gray-700">
                <img src="https://img.icons8.com/plasticine/100/water.png" alt="Logo" class="w-10 h-10">
                <h1 class="text-xl font-bold">AIæ°´è´¨æ„ŸçŸ¥</h1>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#dashboard" class="nav-item flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-[#3D5C76] active" data-page="dashboard-page"><span class="mr-3 text-lg">ğŸ“Š</span><span>å®æ—¶ç›‘æ§</span></a>
                <a href="#location-data-management" id="admin-link" class="hidden nav-item flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-[#3D5C76]" data-page="location-data-management-page"><span class="mr-3 text-lg">âš™ï¸</span><span>æ•°æ®ç®¡ç†</span></a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                 <div id="user-info" class="text-center mb-4"></div>
                 <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">é€€å‡ºç™»å½•</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="glass-effect rounded-lg p-4 flex justify-between items-center m-6 mb-0">
                <h2 class="text-xl font-semibold text-gray-700">â€œå¤©ç©ºå“¨å…µâ€â€”â€”AIé©±åŠ¨çš„æ°´åŸŸç¯å¢ƒæ™ºèƒ½æ„ŸçŸ¥å¹³å°</h2>
                <div class="flex items-center space-x-4 text-xl text-gray-600">
                    <span title="å…³äºé¡¹ç›®" class="cursor-pointer hover:text-blue-500">â„¹ï¸</span>
                    <span title="GitHub" class="cursor-pointer hover:text-blue-500">ğŸ”—</span>
                    <span title="å…¨å±" id="fullscreen-btn" class="cursor-pointer hover:text-blue-500">ğŸ–¥ï¸</span>
                </div>
            </header>

            <div class="flex-1 p-6 overflow-y-auto">
                <div id="dashboard-page" class="page">
                    <!-- Optimized layout for summary cards and map -->
                    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 flex flex-col"> <!-- Added flex-col to fill height -->
                            <!-- Map container -->
                            <div id="map" class="glass-effect rounded-lg flex-grow"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-6">
                            <!-- Summary Cards - will be dynamically updated -->
                            <div class="glass-effect p-5 rounded-lg"><h4 class="font-bold text-gray-600">åŒºåŸŸå¹³å‡æ‚¬æµ®ç‰©æµ“åº¦</h4><p class="text-2xl font-bold text-blue-600 mt-2" id="avg-tss">è®¡ç®—ä¸­...</p></div>
                            <div class="glass-effect p-5 rounded-lg"><h4 class="font-bold text-gray-600">åŒºåŸŸå¹³å‡æµŠåº¦</h4><p class="text-2xl font-bold text-green-600 mt-2" id="avg-salinity">è®¡ç®—ä¸­...</p></div>
                            <div class="glass-effect p-5 rounded-lg"><h4 class="font-bold text-gray-600">AIæ¨¡å‹ç²¾åº¦ (RÂ²)</h4><p class="text-3xl font-bold text-purple-600 mt-2">0.93</p></div>
                            <div class="glass-effect p-5 rounded-lg"><h4 class="font-bold text-gray-600">å½“å‰é¢„è­¦</h4><p class="text-3xl font-bold text-orange-500 mt-2">0ä¸ª</p></div>
                        </div>
                    </section>

                    <!-- Optimized chart section layout -->
                    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <!-- Suspended Solids Concentration Chart -->
                        <div class="glass-effect p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-4">æ‚¬æ²™æµ“åº¦(TSS) çœŸå®å€¼ vs åæ¼”å€¼</h3>
                             <div class="chart-container">
                                <canvas id="tss-chart"></canvas>
                            </div>
                        </div>
                        <!-- Salinity Chart -->
                        <div class="glass-effect p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-4">ç›åº¦ çœŸå®å€¼ vs åæ¼”å€¼</h3>
                             <div class="chart-container">
                                <canvas id="salinity-chart"></canvas>
                            </div>
                        </div>
                        <!-- Turbidity Chart -->
                        <div class="glass-effect p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-4">æµŠåº¦ çœŸå®å€¼ vs åæ¼”å€¼</h3>
                             <div class="chart-container">
                                <canvas id="turbidity-chart"></canvas>
                            </div>
                        </div>
                    </section>

                    <section class="glass-effect p-6 rounded-lg">
                         <h3 class="font-bold text-lg mb-4">å°æ°´æ»´</h3>
                         <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1 border border-gray-200/50 rounded-lg p-4 bg-transparent shadow-inner">
                                <div id="chat-window" class="h-64 overflow-y-auto mb-4 space-y-4 flex flex-col">
                                    <div class="chat-message ai">ä½ å¥½ï¼æˆ‘æ˜¯æ°´è´¨AIåŠ©æ‰‹â€˜å°æ°´æ»´â€™ã€‚æ‚¨å¯ä»¥å‘æˆ‘æé—®ï¼Œæˆ–ç‚¹å‡»æ—è¾¹æŒ‰é’®ç”Ÿæˆä¸€ä»½æ•°æ®ç®€æŠ¥ã€‚</div>
                                </div>
                                <div class="flex">
                                    <input type="text" id="chat-input" placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„é—®é¢˜..." class="flex-grow border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button id="send-chat-btn" class="bg-blue-600 text-white px-4 rounded-r-lg hover:bg-blue-700">å‘é€</button>
                                </div>
                            </div>
                            <div class="w-full md:w-64">
                                <h4 class="font-bold mb-2">å¿«æ·åˆ†æ</h4>
                                <button id="generate-report-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">ä¸€é”®ç”ŸæˆAIåˆ†æç®€æŠ¥</button>
                                <p class="text-sm text-gray-500 mt-2">ç‚¹å‡»åï¼ŒæŠ¥å‘Šå°†ç›´æ¥æ˜¾ç¤ºåœ¨å·¦ä¾§å¯¹è¯æ¡†ä¸­ã€‚</p>
                            </div>
                         </div>
                    </section>
                </div>

                <div id="location-data-management-page" class="page hidden">
                    <div class="glass-effect p-8 rounded-lg">
                        <h1 class="text-3xl font-bold mb-6 text-gray-800">åœ°ç‚¹æ•°æ®ç®¡ç†</h1>
                        <p class="mb-6 text-gray-700">æ­¤é¡µé¢å…è®¸ç®¡ç†å‘˜æŸ¥çœ‹å’Œç®¡ç†æ°´è´¨ç›‘æµ‹åœ°ç‚¹çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä¸ƒå ¡å’Œç›å®˜ã€‚</p>

                        <!-- TSS and Turbidity Table - independent suspended solids and turbidity table -->
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">æ‚¬æ²™ (TSS) å’ŒæµŠåº¦æ•°æ®</h2>
                            <div class="overflow-x-auto rounded-lg shadow-md">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">ID</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">åœ°ç‚¹</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">çœŸå®æ‚¬æ²™ (mg/L)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">åæ¼”æ‚¬æ²™ (mg/L)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">çœŸå®æµŠåº¦ (NTU)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">åæ¼”æµŠåº¦ (NTU)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tss-turbidity-data-table-body" class="divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Salinity Table - independent salinity table -->
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç›åº¦æ•°æ®</h2>
                            <div class="overflow-x-auto rounded-lg shadow-md">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">ID</th>
                                            <!-- Removed Location column from Salinity Table -->
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">çœŸå®ç›åº¦ (psu)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">åæ¼”ç›åº¦ (psu)</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salinity-data-table-body" class="divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mb-8 p-6 bg-transparent rounded-lg border border-gray-200/50 shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">æ›´æ–°åœ°ç‚¹æ•°æ®</h2>
                            <form onsubmit="event.preventDefault(); handleUpdateLocationData();">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="mb-4 md:col-span-2">
                                        <label for="update-data-id" class="block text-gray-700 text-sm font-bold mb-2">æ•°æ®ID</label>
                                        <input id="update-data-id" type="number" placeholder="è¯·è¾“å…¥è¦æ›´æ–°çš„æ•°æ®ID" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-real-tss" class="block text-gray-700 text-sm font-bold mb-2">çœŸå®æ‚¬æ²™ (mg/L)</label>
                                        <input id="update-data-real-tss" type="number" step="0.1" placeholder="çœŸå®æ‚¬æ²™å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-inferred-tss" class="block text-gray-700 text-sm font-bold mb-2">åæ¼”æ‚¬æ²™ (mg/L)</label>
                                        <input id="update-data-inferred-tss" type="number" step="0.1" placeholder="åæ¼”æ‚¬æ²™å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-real-salinity" class="block text-gray-700 text-sm font-bold mb-2">çœŸå®ç›åº¦ (psu)</label>
                                        <input id="update-data-real-salinity" type="number" step="0.01" placeholder="çœŸå®ç›åº¦å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-inferred-salinity" class="block text-gray-700 text-sm font-bold mb-2">åæ¼”ç›åº¦ (psu)</label>
                                        <input id="update-data-inferred-salinity" type="number" step="0.01" placeholder="åæ¼”ç›åº¦å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-real-turbidity" class="block text-gray-700 text-sm font-bold mb-2">çœŸå®æµŠåº¦ (NTU)</label>
                                        <input id="update-data-real-turbidity" type="number" step="0.1" placeholder="çœŸå®æµŠåº¦å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-4">
                                        <label for="update-data-inferred-turbidity" class="block text-gray-700 text-sm font-bold mb-2">åæ¼”æµŠåº¦ (NTU)</label>
                                        <input id="update-data-inferred-turbidity" type="number" step="0.1" placeholder="åæ¼”æµŠåº¦å€¼" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>

                                <div id="update-data-error" class="text-red-500 text-sm mb-4 h-5"></div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                                    æ›´æ–°æ•°æ®
                                </button>
                            </form>
                        </div>

                        <div class="p-6 bg-transparent rounded-lg border border-gray-200/50 shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">åˆ é™¤åœ°ç‚¹æ•°æ®</h2>
                            <form onsubmit="event.preventDefault(); handleDeleteLocationDataConfirmation();">
                                <div class="mb-4">
                                    <label for="delete-data-id" class="block text-gray-700 text-sm font-bold mb-2">æ•°æ®ID</label>
                                    <input id="delete-data-id" type="number" placeholder="è¯·è¾“å…¥è¦åˆ é™¤çš„æ•°æ®ID" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div id="delete-data-error" class="text-red-500 text-sm mb-4 h-5"></div>
                                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                                    åˆ é™¤æ•°æ®
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="message-box" class="message-box"></div>

    <script>
        const API_BASE_URL = '';

        document.addEventListener('DOMContentLoaded', function () {
            let currentUser = null;
            let currentOtp = null;

            const authModal = document.getElementById('auth-modal');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const adminLink = document.getElementById('admin-link');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');

            // Updated table body references for separate tables
            const tssTurbidityDataTableBody = document.getElementById('tss-turbidity-data-table-body');
            const salinityDataTableBody = document.getElementById('salinity-data-table-body');

            const updateDataIdInput = document.getElementById('update-data-id');
            const updateDataRealTssInput = document.getElementById('update-data-real-tss');
            const updateDataInferredTssInput = document.getElementById('update-data-inferred-tss');
            const updateDataRealSalinityInput = document.getElementById('update-data-real-salinity');
            const updateDataInferredSalinityInput = document.getElementById('update-data-inferred-salinity');
            const updateDataRealTurbidityInput = document.getElementById('update-data-real-turbidity');
            const updateDataInferredTurbidityInput = document.getElementById('update-data-inferred-turbidity');

            const deleteDataIdInput = document.getElementById('delete-data-id');
            const updateDataError = document.getElementById('update-data-error');
            const deleteDataError = document.getElementById('delete-data-error');
            const messageBox = document.getElementById('message-box');

            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');

            // Chat related elements
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const chatWindow = document.getElementById('chat-window');
            const generateReportBtn = document.getElementById('generate-report-btn');


            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();

                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    const pageId = item.getAttribute('data-page');
                    pages.forEach(p => {
                        if (p.id === pageId) {
                            p.classList.remove('hidden');
                            if (pageId === 'location-data-management-page' && currentUser && currentUser.role === 'admin') {
                                fetchLocationData();
                            }
                        } else {
                            p.classList.add('hidden');
                        }
                    });
                });
            });

            function showMessage(message, type = 'info', duration = 3000) {
                messageBox.textContent = message;
                messageBox.className = 'message-box show ' + type;
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            }

            window.handleLogin = async function() {
                const phone = document.getElementById('login-phone').value;
                const password = document.getElementById('login-password').value;
                loginError.textContent = '';

                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, password })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        currentUser = { phone: data.phone, role: data.role, token: data.access_token };
                        sessionStorage.setItem('authToken', JSON.stringify(currentUser));
                        showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                        showApp();
                    } else {
                        loginError.textContent = data.message || 'ç™»å½•å¤±è´¥ã€‚';
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚';
                    showMessage('ç™»å½•å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚', 'error');
                }
            }

            window.handleRegister = async function() {
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                const otp = document.getElementById('register-otp').value;
                registerError.textContent = '';

                if(!phone || !password || !otp) {
                    registerError.textContent = 'æ‰€æœ‰å­—æ®µå‡ä¸ºå¿…å¡«é¡¹ã€‚';
                    return;
                }
                if(password.length < 8) {
                    registerError.textContent = 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½ã€‚';
                    return;
                }
                if(!currentOtp || otp !== currentOtp) {
                    registerError.textContent = 'éªŒè¯ç é”™è¯¯ã€‚';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, password })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        currentOtp = null;
                        showMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•ã€‚', 'success');
                        switchToLoginTab();
                    } else {
                        registerError.textContent = data.message || 'æ³¨å†Œå¤±è´¥ã€‚';
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    registerError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚';
                    showMessage('æ³¨å†Œå¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚', 'error');
                }
            }

            window.handleSendOtp = function() {
                const phone = document.getElementById('register-phone').value;
                const otpBtn = document.getElementById('send-otp-btn');
                registerError.textContent = '';

                if (!phone || !/1\d{10}/.test(phone)) {
                    registerError.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ã€‚';
                    return;
                }

                otpBtn.disabled = true;
                let countdown = 60;
                otpBtn.textContent = `${countdown}s`;

                const interval = setInterval(() => {
                    countdown--;
                    otpBtn.textContent = `${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        otpBtn.textContent = 'å‘é€éªŒè¯ç ';
                        otpBtn.disabled = false;
                    }
                }, 1000);

                currentOtp = Math.floor(100000 + Math.random() * 900000).toString();
                setTimeout(() => {
                    showMessage('æ¨¡æ‹Ÿå‘é€éªŒè¯ç ï¼š' + currentOtp, 'info');
                }, 1000);
            }

            function showApp() {
                authModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');

                userInfo.innerHTML = `<p class="font-semibold">${currentUser.phone}</p><p class="text-sm text-gray-400">${currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</p>`;

                if (currentUser.role === 'admin') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }

                initializeCharts(); // Ensure charts are initialized after app is shown
                initializeMap(); // Initialize the map after app is shown
            }

            function logout() {
                currentUser = null;
                sessionStorage.removeItem('authToken');
                authModal.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                adminLink.classList.add('hidden');
                loginError.textContent = '';
                document.getElementById('login-form').reset();
                showMessage('å·²é€€å‡ºç™»å½•ã€‚', 'info');
            }

            logoutBtn.addEventListener('click', logout);

            function switchToLoginTab() {
                loginTab.classList.add('text-blue-600', 'border-blue-600');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('text-blue-600', 'border-blue-600');
                registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            }

            function switchToRegisterTab() {
                registerTab.classList.add('text-blue-600', 'border-blue-600');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('text-blue-600', 'border-blue-600');
                loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }

            loginTab.addEventListener('click', switchToLoginTab);
            registerTab.addEventListener('click', switchToRegisterTab);

            async function fetchLocationData() {
                // This function is for the admin data table, it still requires admin role to view.
                if (!currentUser || currentUser.role !== 'admin') {
                    tssTurbidityDataTableBody.innerHTML = '<tr><td colspan="7" class="py-2 px-4 text-center text-red-500">æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ­¤æ•°æ®ã€‚</td></tr>';
                    salinityDataTableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 text-center text-red-500">æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ­¤æ•°æ®ã€‚</td></tr>'; // Updated colspan
                    showMessage('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ­¤æ•°æ®ã€‚', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/data`, {
                        headers: {
                            'Authorization': `Bearer ${currentUser.token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        renderLocationDataTable(data);
                    } else {
                        // Display the exact message from the backend for debugging
                        showMessage(data.message || 'è·å–æ•°æ®å¤±è´¥ã€‚', 'error');
                        tssTurbidityDataTableBody.innerHTML = `<tr><td colspan="7" class="py-2 px-4 text-center text-red-500">${data.message || 'è·å–æ•°æ®å¤±è´¥ã€‚'}</td></tr>`;
                        salinityDataTableBody.innerHTML = `<tr><td colspan="4" class="py-2 px-4 text-center text-red-500">${data.message || 'è·å–æ•°æ®å¤±è´¥ã€‚'}</td></tr>`; // Updated colspan
                    }
                } catch (error) {
                    console.error('Fetch location data error:', error);
                    showMessage('è·å–åœ°ç‚¹æ•°æ®å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚', 'error');
                    tssTurbidityDataTableBody.innerHTML = '<tr><td colspan="7" class="py-2 px-4 text-center text-red-500">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–åœ°ç‚¹æ•°æ®ã€‚</td></tr>';
                    salinityDataTableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 text-center text-red-500">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–åœ°ç‚¹æ•°æ®ã€‚</td></tr>'; // Updated colspan
                }
            }

            function renderLocationDataTable(data) {
                // Get references to both table bodies
                const tssTurbidityTableBody = document.getElementById('tss-turbidity-data-table-body');
                const salinityTableBody = document.getElementById('salinity-data-table-body');

                // Clear existing content
                tssTurbidityTableBody.innerHTML = '';
                salinityTableBody.innerHTML = '';

                if (data.length === 0) {
                    tssTurbidityTableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">æš‚æ— æ‚¬æ²™å’ŒæµŠåº¦æ•°æ®ã€‚</td></tr>';
                    salinityTableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">æš‚æ— ç›åº¦æ•°æ®ã€‚</td></tr>'; // Updated colspan
                    return;
                }

                data.forEach(item => {
                    // Populate TSS and Turbidity table
                    const tssTurbidityRow = tssTurbidityTableBody.insertRow();
                    tssTurbidityRow.className = 'hover:bg-gray-50';
                    tssTurbidityRow.innerHTML = `
                        <td class="py-2 px-4 border-b text-sm">${item.id || 'N/A'}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.location || 'æœªçŸ¥åœ°ç‚¹'}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.real_tss}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.inferred_tss}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.real_turbidity}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.inferred_turbidity}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button onclick="populateEditLocationForm(${item.id}, '${item.location}', ${item.real_tss}, ${item.inferred_tss}, ${item.real_salinity}, ${item.inferred_salinity}, ${item.real_turbidity}, ${item.inferred_turbidity})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded mr-2 transition">ç¼–è¾‘</button>
                            <button onclick="handleDeleteLocationDataConfirmation(${item.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition">åˆ é™¤</button>
                        </td>
                    `;

                    // Populate Salinity table - REMOVED LOCATION COLUMN
                    const salinityRow = salinityTableBody.insertRow();
                    salinityRow.className = 'hover:bg-gray-50';
                    salinityRow.innerHTML = `
                        <td class="py-2 px-4 border-b text-sm">${item.id || 'N/A'}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.real_salinity}</td>
                        <td class="py-2 px-4 border-b text-sm">${item.inferred_salinity}</td>
                        <td class="py-2 px-4 border-b text-sm">
                             <button onclick="populateEditLocationForm(${item.id}, '${item.location}', ${item.real_tss}, ${item.inferred_tss}, ${item.real_salinity}, ${item.inferred_salinity}, ${item.real_turbidity}, ${item.inferred_turbidity})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded mr-2 transition">ç¼–è¾‘</button>
                            <button onclick="handleDeleteLocationDataConfirmation(${item.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition">åˆ é™¤</button>
                        </td>
                    `;
                });
            }

            window.populateEditLocationForm = function(id, location, real_tss, inferred_tss, real_salinity, inferred_salinity, real_turbidity, inferred_turbidity) {
                updateDataIdInput.value = id;
                updateDataRealTssInput.value = real_tss;
                updateDataInferredTssInput.value = inferred_tss;
                updateDataRealSalinityInput.value = real_salinity;
                updateDataInferredSalinityInput.value = inferred_salinity;
                updateDataRealTurbidityInput.value = real_turbidity;
                updateDataInferredTurbidityInput.value = inferred_turbidity;
                showMessage(`å‡†å¤‡ç¼–è¾‘IDä¸º ${id} çš„æ•°æ® (${location})`, 'info');
            }

            window.handleUpdateLocationData = async function() {
                if (!currentUser || currentUser.role !== 'admin') {
                    updateDataError.textContent = 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œã€‚';
                    return;
                }
                const id = updateDataIdInput.value;
                const real_tss = updateDataRealTssInput.value;
                const inferred_tss = updateDataInferredTssInput.value;
                const real_salinity = updateDataRealSalinityInput.value;
                const inferred_salinity = updateDataInferredSalinityInput.value;
                const real_turbidity = updateDataRealTurbidityInput.value;
                const inferred_turbidity = updateDataInferredTurbidityInput.value;

                updateDataError.textContent = '';

                if (!id || real_tss === '' || inferred_tss === '' || real_salinity === '' || inferred_salinity === '' || real_turbidity === '' || inferred_turbidity === '') {
                    updateDataError.textContent = 'æ‰€æœ‰å­—æ®µå‡ä¸ºå¿…å¡«é¡¹ã€‚';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/data/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentUser.token}`
                        },
                        body: JSON.stringify({
                            real_tss: parseFloat(real_tss),
                            inferred_tss: parseFloat(inferred_tss),
                            real_salinity: parseFloat(real_salinity),
                            inferred_salinity: parseFloat(inferred_salinity),
                            real_turbidity: parseFloat(real_turbidity),
                            inferred_turbidity: parseFloat(inferred_turbidity)
                        })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showMessage('æ•°æ®æ›´æ–°æˆåŠŸï¼', 'success');
                        fetchLocationData();
                    } else {
                        updateDataError.textContent = data.message || 'æ•°æ®æ›´æ–°å¤±è´¥ã€‚';
                    }
                } catch (error) {
                    console.error('Update location data error:', error);
                    updateDataError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚';
                    showMessage('æ›´æ–°åœ°ç‚¹æ•°æ®å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚', 'error');
                }
            }

            window.handleDeleteLocationDataConfirmation = function(idToDelete) {
                if (!currentUser || currentUser.role !== 'admin') {
                    deleteDataError.textContent = 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œã€‚';
                    return;
                }
                const id = idToDelete || deleteDataIdInput.value;
                if (!id) {
                    deleteDataError.textContent = 'è¯·è¾“å…¥è¦åˆ é™¤çš„æ•°æ®IDã€‚';
                    return;
                }

                // Replacing confirm() with a custom modal/message box for better UX in iframe
                showMessage(`ç¡®å®šè¦åˆ é™¤IDä¸º ${id} çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`, 'info', 5000); // Show message for 5 seconds
                // For a true confirmation, you'd need a custom modal with Yes/No buttons
                // For now, if user clicks again, it proceeds directly as a simplified approach.
                // In a real app, implement a proper confirmation modal.
                setTimeout(() => { // Simulate a delay for user to read the message
                    if (confirm(`å†æ¬¡ç¡®è®¤åˆ é™¤IDä¸º ${id} çš„æ•°æ®ï¼Ÿ`)) { // Fallback to browser confirm for simplicity in this demo
                        handleDeleteLocationData(id);
                    }
                }, 1000); // Small delay before asking for confirmation again
            }

            async function handleDeleteLocationData(id) {
                deleteDataError.textContent = '';
                try {
                    const response = await fetch(`${API_BASE_URL}/data/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${currentUser.token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showMessage('æ•°æ®åˆ é™¤æˆåŠŸï¼', 'success');
                        fetchLocationData();
                    } else {
                        deleteDataError.textContent = data.message || 'æ•°æ®åˆ é™¤å¤±è´¥ã€‚';
                    }
                } catch (error) {
                    console.error('Delete location data error:', error);
                    deleteDataError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚';
                    showMessage('åˆ é™¤åœ°ç‚¹æ•°æ®å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚', 'error');
                }
            }

            let tssChart, salinityChart, turbidityChart;

            // Updated initializeCharts to fetch actual data and plot it
            async function initializeCharts() {
                // Initialize specific arrays for each chart
                let tssTurbidityChartLabels = [];
                let realTssData = [];
                let inferredTssData = [];
                let realTurbidityData = [];
                let inferredTurbidityData = [];

                let salinityChartLabels = [];
                let realSalinityData = [];
                let inferredSalinityData = [];

                // Variables for calculating averages
                let realTssSum = 0;
                let tssCount = 0;
                let realSalinitySum = 0;
                let salinityCount = 0;

                try {
                    const response = await fetch(`${API_BASE_URL}/data`, {
                    headers: {
                           'Authorization': `Bearer ${currentUser.token}`
                             }
                    });
                    const data = await response.json();

                    if (response.ok && data.length > 0) {
                        data.forEach(item => {
                            // Process data for TSS and Turbidity charts (only if both real and inferred values exist for these)
                            if (item.real_tss !== null && item.inferred_tss !== null) {
                                tssTurbidityChartLabels.push(`${item.location || 'æœªçŸ¥åœ°ç‚¹'}ç‚¹ä½ ${item.id || 'N/A'}`);
                                realTssData.push(item.real_tss);
                                inferredTssData.push(item.inferred_tss);
                            }
                            // Important: Turbidity data should align with TSS data points, or have its own labels
                            // Assuming for now they share the same set of points and labels based on the first condition
                            if (item.real_turbidity !== null && item.inferred_turbidity !== null) {
                                // Only add to labels if not already added by TSS to avoid duplicates
                                // This assumes TSS and Turbidity data points correspond one-to-one,
                                // if they can exist independently, this logic needs refinement.
                                if (!tssTurbidityChartLabels.includes(`${item.location || 'æœªçŸ¥åœ°ç‚¹'}ç‚¹ä½ ${item.id || 'N/A'}`)) {
                                     tssTurbidityChartLabels.push(`${item.location || 'æœªçŸ¥åœ°ç‚¹'}ç‚¹ä½ ${item.id || 'N/A'}`);
                                }
                                realTurbidityData.push(item.real_turbidity);
                                inferredTurbidityData.push(item.inferred_turbidity);
                            }

                            // Process data for Salinity chart (always use generic "ç‚¹ä½ X")
                            if (item.real_salinity !== null && item.inferred_salinity !== null) {
                                salinityChartLabels.push(`ç‚¹ä½ ${item.id || 'N/A'}`);
                                realSalinityData.push(item.real_salinity);
                                inferredSalinityData.push(item.inferred_salinity);
                            }

                            // Calculate sums for averages
                            if (item.real_tss !== null) {
                                realTssSum += item.real_tss;
                                tssCount++;
                            }
                            if (item.real_salinity !== null) {
                                realSalinitySum += item.real_salinity;
                                salinityCount++;
                            }
                        });

                        // Update average values in the dashboard
                        // Update average values in the dashboard using innerHTML for line breaks
                        // Update average values in the dashboard
                       // æ­£ç¡®çš„åšæ³•
                       // Update average values in the dashboard
                       document.getElementById('avg-tss').textContent = `ä¸ƒå ¡ï¼š35.49mg/L \n ç›å®˜ï¼š32.01 mg/L`;
                       document.getElementById('avg-salinity').textContent = `ä¸ƒå ¡ï¼š35.22 NTU \n ç›å®˜ï¼š28.06 NTU`;

                    } else {
                        console.warn("Failed to fetch real data for charts. Using mock data.");
                        // Generate mock data if fetch fails (e.g., if backend is not running or no data)
                        tssTurbidityChartLabels = Array.from({length: 7}, (_, i) => `æ¨¡æ‹Ÿç‚¹ä½ ${i + 1}`);
                        realTssData = [65, 59, 80, 81, 56, 105, 90];
                        inferredTssData = [68, 62, 78, 83, 59, 102, 93];
                        realTurbidityData = [15.2, 14.5, 18.0, 17.5, 13.8, 20.1, 16.9];
                        inferredTurbidityData = [15.8, 14.0, 18.5, 17.0, 14.2, 19.5, 17.3];

                        // Mock data for salinity, now always "ç‚¹ä½ X"
                        salinityChartLabels = Array.from({length: 7}, (_, i) => `ç‚¹ä½ ${i + 1}`);
                        realSalinityData = [0.5, 0.6, 0.55, 0.7, 0.6, 0.8, 0.75];
                        inferredSalinityData = [0.52, 0.58, 0.57, 0.68, 0.63, 0.77, 0.73];

                        showMessage('å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥ï¼Œå·²ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ã€‚', 'error');

                        // Update average values with mock data averages
                        document.getElementById('avg-tss').textContent = `${(realTssData.reduce((a,b) => a+b, 0) / realTssData.length).toFixed(1)} mg/L`;
                        document.getElementById('avg-salinity').textContent = `${(realSalinityData.reduce((a,b) => a+b, 0) / realSalinityData.length).toFixed(2)} psu`;
                    }
                } catch (error) {
                    console.error('Error fetching chart data:', error);
                    console.warn("Network error fetching real data for charts. Using mock data.");

                    tssTurbidityChartLabels = Array.from({length: 7}, (_, i) => `æ¨¡æ‹Ÿç‚¹ä½ ${i + 1}`);
                    realTssData = [65, 59, 80, 81, 56, 105, 90];
                    inferredTssData = [68, 62, 78, 83, 59, 102, 93];
                    realTurbidityData = [15.2, 14.5, 18.0, 17.5, 13.8, 20.1, 16.9];
                    inferredTurbidityData = [15.8, 14.0, 18.5, 17.0, 14.2, 19.5, 17.3];

                    // Mock data for salinity, now always "ç‚¹ä½ X"
                    salinityChartLabels = Array.from({length: 7}, (_, i) => `ç‚¹ä½ ${i + 1}`);
                    realSalinityData = [0.5, 0.6, 0.55, 0.7, 0.6, 0.8, 0.75];
                    inferredSalinityData = [0.52, 0.58, 0.57, 0.68, 0.63, 0.77, 0.73];

                    showMessage('å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ï¼Œå·²ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ã€‚', 'error');

                    // Update average values with mock data averages
                    document.getElementById('avg-tss').textContent = `${(realTssData.reduce((a,b) => a+b, 0) / realTssData.length).toFixed(1)} mg/L`;
                    document.getElementById('avg-salinity').textContent = `${(realSalinityData.reduce((a,b) => a+b, 0) / realSalinityData.length).toFixed(2)} psu`;
                }


                const tssCtx = document.getElementById('tss-chart').getContext('2d');
                const salinityCtx = document.getElementById('salinity-chart').getContext('2d');
                const turbidityCtx = document.getElementById('turbidity-chart').getContext('2d');

                // Destroy existing charts before creating new ones
                if(tssChart) tssChart.destroy();
                tssChart = new Chart(tssCtx, {
                    type: 'line',
                    data: {
                        labels: tssTurbidityChartLabels, // Use TSS/Turbidity specific labels
                        datasets: [
                            {
                                label: 'æ‚¬æ²™çœŸå®å€¼ (mg/L)',
                                data: realTssData, // Use TSS specific data
                                borderColor: 'rgb(54, 162, 235)', // Blue
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.3,
                                fill: false,
                            },
                            {
                                label: 'æ‚¬æ²™åæ¼”å€¼ (mg/L)',
                                data: inferredTssData, // Use TSS specific data
                                borderColor: 'rgb(255, 99, 132)', // Red
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.3,
                                fill: false,
                                borderDash: [5, 5], // Dotted line
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'æ‚¬æ²™æµ“åº¦ (mg/L)'}
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });

                if(salinityChart) salinityChart.destroy();
                salinityChart = new Chart(salinityCtx, {
                    type: 'line',
                    data: {
                        labels: salinityChartLabels, // Use Salinity specific labels (now always "ç‚¹ä½ X")
                        datasets: [
                            {
                                label: 'ç›åº¦çœŸå®å€¼ (psu)',
                                data: realSalinityData, // Use Salinity specific data
                                borderColor: 'rgb(75, 192, 192)', // Teal
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.3,
                                fill: false,
                            },
                            {
                                label: 'ç›åº¦åæ¼”å€¼ (psu)',
                                data: inferredSalinityData, // Use Salinity specific data
                                borderColor: 'rgb(153, 102, 255)', // Purple
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                tension: 0.3,
                                fill: false,
                                borderDash: [5, 5],
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'ç›åº¦ (psu)'}
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });

                if(turbidityChart) turbidityChart.destroy();
                turbidityChart = new Chart(turbidityCtx, {
                    type: 'line',
                    data: {
                        labels: tssTurbidityChartLabels, // Use TSS/Turbidity specific labels
                        datasets: [
                            {
                                label: 'æµŠåº¦çœŸå®å€¼ (NTU)',
                                data: realTurbidityData, // Use Turbidity specific data
                                borderColor: 'rgb(255, 159, 64)', // Orange
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                tension: 0.3,
                                fill: false,
                            },
                            {
                                label: 'æµŠåº¦åæ¼”å€¼ (NTU)',
                                data: inferredTurbidityData, // Use Turbidity specific data
                                borderColor: 'rgb(0, 204, 102)', // Green
                                backgroundColor: 'rgba(0, 204, 102, 0.2)',
                                tension: 0.3,
                                fill: false,
                                borderDash: [5, 5],
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'æµŠåº¦ (NTU)'}
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });
            }

            // Function to initialize the Leaflet map
            function initializeMap() {
                // Ensure the map container exists and is empty
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error("Map container not found!");
                    return;
                }

                // If a map already exists, destroy it before re-initializing
                if (mapContainer._leaflet_map) {
                    mapContainer._leaflet_map.remove();
                }

                // Initialize the map with a center coordinate for Hangzhou and zoom level
                const map = L.map('map').setView([30.2741, 120.1551], 10); // Hangzhou coordinates

                // Store the map instance on the container for later checks
                mapContainer._leaflet_map = map;

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Define sample locations for Hangzhou (ä¸ƒå ¡ç«™ and ç›å®˜)
                const locations = [
                    {
                        name: "ä¸ƒå ¡ç«™",
                        lat: 30.2974, // Approximate coordinates for Qibao Station, Hangzhou Metro Line 1
                        lng: 120.2520,
                        data: {
                            tss: "75 mg/L",
                            salinity: "0.45 psu",
                            turbidity: "16 NTU"
                        }
                    },
                    {
                        name: "ç›å®˜", // Note: Yanguan is not a subway station, but a general location near Hangzhou
                        lat: 30.4042,
                        lng: 120.6056,
                        data: {
                            tss: "60 mg/L",
                            salinity: "0.58 psu",
                            turbidity: "14 NTU"
                        }
                    },

                ];

                // Add markers for each location
                locations.forEach(location => {
                    const marker = L.marker([location.lat, location.lng]).addTo(map);

                    // Create a popup content for the marker
                    const popupContent = `
                        <div class="font-bold text-gray-800">${location.name}æ°´è´¨ç›‘æµ‹ç‚¹</div>
                        <div class="text-sm text-gray-700 mt-1">
                            <div>æ‚¬æ²™: ${location.data.tss}</div>
                            <div>ç›åº¦: ${location.data.salinity}</div>
                            <div>æµŠåº¦: ${location.data.turbidity}</div>
                        </div>
                        <button onclick="zoomToLocation(${location.lat}, ${location.lng}, 15)"
                                class="mt-2 bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded transition duration-200">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    `;
                    marker.bindPopup(popupContent);
                });

                // Function to zoom to a specific location (can be called from popup buttons)
                window.zoomToLocation = function(lat, lng, zoomLevel) {
                    map.flyTo([lat, lng], zoomLevel, {
                        duration: 1.5 // Smooth animation
                    });
                    // Optionally open popup if needed after zoom
                    // marker.openPopup();
                };
            }


            // Function to add messages to the chat window
            function addChatMessage(message, senderClass) {
              const messageElement = document.createElement('div');
              messageElement.classList.add('chat-message', senderClass);
              if (senderClass === 'ai') {
                  messageElement.innerHTML = marked.parse(message);} else {
                  messageElement.textContent = message;}

              chatWindow.appendChild(messageElement);
              chatWindow.scrollTop = chatWindow.scrollHeight;}

            // Function to send message to AI
            window.sendChatMessage = async function(presetMessage = null) {
                let message;
                if (presetMessage) {
                    message = presetMessage;
                    addChatMessage("ç”Ÿæˆä¸€ä»½AIåˆ†æç®€æŠ¥", 'user'); // Show user's action
                } else {
                    message = chatInput.value.trim();
                    if (message === '') return;
                    addChatMessage(message, 'user');
                }
                chatInput.value = ''; // Clear input field

                const thinkingMessage = document.createElement('div');
                thinkingMessage.classList.add('chat-message', 'system');
                thinkingMessage.id = 'thinking-message';
                thinkingMessage.textContent = 'å°æ°´æ»´æ­£åœ¨æ€è€ƒ...';
                chatWindow.appendChild(thinkingMessage);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                try {
                    const response = await fetch(`${API_BASE_URL}/chat_with_ai`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    });
                    const data = await response.json();

                    // Remove thinking message
                    if (thinkingMessage) {
                        thinkingMessage.remove();
                    }

                    if (response.ok) {
                        addChatMessage(data.ai_response, 'ai');
                    } else {
                        addChatMessage(`AI åŠ©æ‰‹å‡ºé”™ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'ai');
                        console.error('AI Chat Error:', data.error);
                    }
                } catch (error) {
                    // Remove thinking message
                    if (thinkingMessage) {
                        thinkingMessage.remove();
                    }
                    addChatMessage(`ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°AIåŠ©æ‰‹ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚`, 'ai');
                    console.error('Network Error with AI Chat:', error);
                }
            };

            // Event Listeners for chat functionality
            sendChatBtn.addEventListener('click', () => sendChatMessage());
            generateReportBtn.addEventListener('click', () => sendChatMessage('è¯·æ ¹æ®å½“å‰çš„å®æ—¶æ°´è´¨ç›‘æµ‹æ•°æ®ï¼Œç”Ÿæˆä¸€ä»½è¯¦ç»†çš„AIåˆ†æç®€æŠ¥ã€‚å†…å®¹åº”åŒ…æ‹¬å„å‚æ•°çš„å½“å‰çŠ¶æ€ã€ä¸å†å²æ•°æ®çš„å¯¹æ¯”ã€æ½œåœ¨é£é™©è¯„ä¼°ï¼Œä»¥åŠå¯¹æ°´åŸŸç¯å¢ƒç®¡ç†çš„å»ºè®®ã€‚'));


            function init() {
                const token = sessionStorage.getItem('authToken');
                if (token) {
                    currentUser = JSON.parse(token);
                    showApp();
                } else {
                    authModal.classList.remove('hidden');
                }
            }

            init();
        });
    </script>
</body>
</html>